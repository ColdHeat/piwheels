digraph piwheels {
    graph [nodesep=0.5, ranksep=1, style=filled, fontname=Roboto, fontsize=14, fillcolor="#cccccc"];
    node [shape=record, fontname=Roboto, fontsize=10, style=filled, fillcolor="#9999ff", penwidth=1];
    edge [fontname=Sans, fontsize=8];

    PyPI [label="PyPI", shape=egg];
    Users [label="Users", shape=egg];

    subgraph cluster_db_server {
        graph [label="db-server"];

        TheOracle1 [label="{<Seraph>REQ|<t>TheOracle}"];
        TheOracle2 [label="{<Seraph>REQ|<t>TheOracle}"];
        TheOracle3 [label="{<Seraph>REQ|<t>TheOracle}"];
        TheArchitect [label="{<builds>REP|<t>TheArchitect}"];
        Seraph [label="{<db>ROUTER|<t>Seraph|<oracle>ROUTER}"];
        db [label="piwheels\ndatabase", shape=folder];

        Seraph:oracle->TheOracle1:Seraph [dir=both];
        Seraph:oracle->TheOracle2:Seraph [dir=both];
        Seraph:oracle->TheOracle3:Seraph [dir=both];
        TheOracle1:t->db [dir=both];
        TheOracle2:t->db [dir=both];
        TheOracle3:t->db [dir=both];
        TheArchitect:t->db [dir=back];
    }

    subgraph cluster_file_server {
        graph [label="file-server"];

        FileJuggler [label="{{<fs>REP|<slaves>ROUTER}|<t>FileJuggler}"];
        IndexScribe [label="{{<db>REQ|<indexes>PULL}|<t>IndexScribe}"];
        fs [label="www\nfilesystem", shape=folder];
        httpd;

        IndexScribe:t->fs;
        FileJuggler:t->fs [dir=both];
        fs->httpd;
    }

    subgraph cluster_master {
        graph [label="master"];

        CloudGazer [label="{<t>CloudGazer|<db>REQ}"];
        main [label="{{<int_status>PULL}|main|{<control>PULL|<ext_status>PUB}}"];
        BigBrother [label="{<t>BigBrother|{<int_status>PUSH|<db>REQ|<fs>REQ|<indexes>PUSH}}"];
        SlaveDriver [label="{{<slaves>ROUTER}|<t>SlaveDriver|{<int_status>PUSH|<builds>REQ|<db>REQ|<fs>REQ|<indexes>PUSH}}"];

        BigBrother:int_status->main:int_status;
        SlaveDriver:int_status->main:int_status;
    }

    subgraph cluster_monitor {
        graph [label="monitor"];
        monitor [label="{{<control>PUSH|<status>SUB}|<t>main}"];
    }

    subgraph cluster_Slave1 {
        graph [label="slave1"];
        Slave1 [label="{<t>main|{<builds>REQ|<files>DEALER}}"];
    }

    subgraph cluster_Slave2 {
        graph [label="slave2"];
        Slave2 [label="{<t>main|{<builds>REQ|<files>DEALER}}"];
    }

    PyPI->CloudGazer:t;
    PyPI->Slave1:t;
    PyPI->Slave2:t;
    Slave1:builds->SlaveDriver:slaves [dir=both];
    Slave2:builds->SlaveDriver:slaves [dir=both];
    Slave1:files->FileJuggler:slaves [dir=both];
    Slave2:files->FileJuggler:slaves [dir=both];
    main:ext_status->monitor:status;
    monitor:control->main:control;

    CloudGazer:db->Seraph:db [dir=both];
    BigBrother:indexes->IndexScribe:indexes;
    SlaveDriver:indexes->IndexScribe:indexes;
    IndexScribe:db->Seraph:db [dir=both];
    BigBrother:db->Seraph:db [dir=both];
    BigBrother:fs->FileJuggler:fs [dir=both];
    SlaveDriver:fs->FileJuggler:fs [dir=both];
    SlaveDriver:db->Seraph:db [dir=both];
    SlaveDriver:builds->TheArchitect:builds [dir=both];
    httpd->Users;
}
