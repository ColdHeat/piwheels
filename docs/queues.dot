digraph piwheels {
    graph [nodesep=1, ranksep=1, style=filled, fontname=Sans, fontsize=14, fillcolor="#cccccc"];
    node [shape=record, fontname=Sans, fontsize=10, style=filled, fillcolor="#9999ff", penwidth=1];
    edge [fontname=Sans, fontsize=8];

    pypi [label="PyPI", shape=egg];

    subgraph cluster_master {
        graph [label="master"];

        main [label="{{<int_status>PULL}|main|{<control>PULL|<ext_status>PUB}}"];
        web_scraper [label="<t>web_scraper"];
        queue_stuffer [label="{<t>queue_stuffer|<builds>PUSH}"];
        big_brother [label="{<t>big_brother|<int_status>PUSH}"];
        slave_driver [label="{{<builds>PULL|<slaves>ROUTER}|<t>slave_driver|{<indexes>PUSH|<int_status>PUSH}}"];
        build_catcher [label="{<slaves>ROUTER|<t>build_catcher}"];
        index_scribbler [label="{<indexes>PULL|<t>index_scribbler}"];

        big_brother:int_status->main:int_status [label="inproc://\nstatus"];
        slave_driver:int_status->main:int_status [label="inproc://\nstatus"];
        queue_stuffer:builds->slave_driver:builds [label="inproc://\nbuilds"];
        slave_driver:indexes->index_scribbler:indexes [label="inproc://\nindexes"];

        db [label="piwheels\ndatabase", shape=folder];
        fs [label="www\nfilesystem", shape=folder];

        web_scraper:t->db;
        db->queue_stuffer:t;
        db->big_brother:t;
        slave_driver:t->db;
        db->index_scribbler:t;

        index_scribbler:t->fs;
        build_catcher:t->fs;
    }

    subgraph cluster_monitor {
        graph [label="monitor"];
        monitor [label="{<status>SUB|<t>main|<control>PUSH}"];
    }

    subgraph cluster_slave1 {
        graph [label="slave1"];
        slave1 [label="{<t>main|{<builds>DEALER|<files>DEALER}}"];
    }

    subgraph cluster_slave2 {
        graph [label="slave2"];
        slave2 [label="{<t>main|{<builds>DEALER|<files>DEALER}}"];
    }

    pypi->web_scraper:t;
    pypi->slave1:t;
    pypi->slave2:t;
    slave1:builds->slave_driver:slaves [dir=both, label="tcp://\n*:5555"];
    slave2:builds->slave_driver:slaves [dir=both, label="tcp://\n*:5555"];
    slave1:files->build_catcher:slaves [dir=both, label="tcp://\n*:5556"];
    slave2:files->build_catcher:slaves [dir=both, label="tcp://\n*:5556"];
    main:ext_status->monitor:status [label="ipc://\n/tmp/piw-status"];
    monitor:control->main:control [label="ipc://\n/tmp/piw-control"];
}
